<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DRONE-NAV: AI AGENT RESEARCH</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
*{margin:0;padding:0;box-sizing:border-box;touch-action:none;user-select:none;-webkit-user-select:none}
body{background:#05050a;display:flex;flex-direction:column;align-items:center;min-height:100vh;font-family:'Press Start 2P',monospace;overflow:hidden;padding:10px 0}
#header{display:flex;justify-content:space-between;width:min(560px,96vw);padding:8px 0;color:#0ff;font-size:min(10px,2.2vw)}
.score-value{color:#fff;margin-top:3px}
#game-container{position:relative;border:2px solid #0ff;border-radius:8px;width:min(560px,96vw);max-height:60vh;aspect-ratio:28/31;background:#000;outline:none}
canvas{display:block;width:100%;height:100%}
#ai-panel{width:min(560px,96vw);margin-top:10px;background:#0e0e1a;border:1px solid #333;border-radius:6px;padding:8px;font-size:8px;color:#888;display:block}
.ai-title{color:#0f0;margin-bottom:6px;font-size:9px}
.ai-row{display:flex;justify-content:space-between;margin-bottom:4px}
.ai-val{color:#fff}
#overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.9);z-index:10;border-radius:6px;cursor:pointer}
#overlay.hidden{display:none}
h1{color:#0ff;font-size:min(18px,5vw);margin-bottom:10px;text-align:center}
.start-hint{color:#0f0;font-size:10px;margin-top:20px;animation:blink 1s step-end infinite;padding:12px 20px;border:2px solid #0f0;border-radius:8px}
#ready-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#0f0;font-size:16px;z-index:5;display:none}
@keyframes blink{50%{opacity:0}}
</style>
</head>
<body>
<div id="header">
  <div><div>DATA</div><div class="score-value" id="score">0</div></div>
  <div style="text-align:right"><div>HULLS</div><div class="score-value" id="lives-display">â–²â–²â–²</div></div>
</div>
<div id="game-container" tabindex="0">
  <canvas id="game"></canvas>
  <div id="overlay">
    <h1>AUTONOMOUS<br>AGENT SIM</h1>
    <div class="start-hint">INITIALIZE SYSTEM</div>
  </div>
  <div id="ready-text">BOOTING...</div>
</div>
<div id="ai-panel">
  <div class="ai-title">ðŸ§  AGENT TELEMETRY</div>
  <div class="ai-row"><span>PATHFINDING</span><span class="ai-val" id="ai-astar">WEIGHTED A*</span></div>
  <div class="ai-row"><span>REINFORCEMENT</span><span class="ai-val" id="ai-qlearn">Q-LEARNING ACTIVE</span></div>
  <div class="ai-row"><span>EXPLORATION (Îµ)</span><span class="ai-val" id="ai-eps">0.20</span></div>
</div>

<script>
let audioCtx, af=0;
function unlockAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

const T=20,C=28,R=31,DIRS=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}];
const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
canvas.width=C*T; canvas.height=R*T;
const MS=["1111111111111111111111111111","1222222222222112222222222221","1211112111112112111121111121","1311112111112112111121111131","1211112111112112111121111121","1222222222222222222222222221","1211112112111111211211112121","1211112112111111211211112121","1222222112222112222112222221","1111112111110110111121111121","0000012111110110111121000000","0000012110000000011121000000","0000012110111411011121000000","1111112110100001011121111111","5000002000100001000002000005","1111112110100001011121111111","0000012110111111011121000000","0000012110000000011121000000","0000012110111111011121000000","1111112110111111011121111111","1222222222222112222222222221","1211112111112112111121111121","1211112111112112111121111121","1322112222222002222222112231","1112112112111111211211211121","1112112112111111211211211121","1222222112222112222112222221","1211111111112112111111111121","1211111111112112111111111121","1222222222222222222222222221","1111111111111111111111111111"];

let map=[],totalDots=0,dotsEaten=0,score=0,lives=3,gs='menu',frightT=0;

function initMap(){map=[];totalDots=0;dotsEaten=0;for(let r=0;r<R;r++){map[r]=[];for(let c=0;c<C;c++){map[r][c]=+MS[r][c];if(map[r][c]===2||map[r][c]===3)totalDots++;}}}

// ==== A* PATHFINDING ====
function astar(sx,sy,gx,gy){
  const key=(x,y)=>`${x},${y}`, open=[{x:sx,y:sy,g:0,f:0,p:null}], cl=new Set();
  while(open.length){
    let bi=0; for(let i=1;i<open.length;i++) if(open[i].f<open[bi].f) bi=i;
    const c=open.splice(bi,1)[0];
    if(c.x===gx && c.y===gy){ let n=c; while(n.p && n.p.p) n=n.p; return n.p?{x:n.x-sx,y:n.y-sy}:{x:0,y:0}; }
    cl.add(key(c.x,c.y));
    for(const d of DIRS){
      let nx=(c.x+d.x+C)%C, ny=c.y+d.y;
      if(ny<0||ny>=R||map[ny][nx]===1||cl.has(key(nx,ny))) continue;
      open.push({x:nx,y:ny,g:c.g+1,f:c.g+1+Math.abs(nx-gx)+Math.abs(ny-gy),p:c});
    }
    if(open.length>200) break;
  } return null;
}

// ==== Q-LEARNING STATE ====
let qTable = {}; 
const eps = 0.2;

let scout={x:14,y:23,dir:{x:0,y:0},want:{x:-1,y:0},tick:0,moving:false};

class Interceptor {
  constructor(i, col){this.i=i; this.col=col; this.reset();}
  reset(){this.x=12+this.i; this.y=14; this.dir={x:0,y:-1}; this.mp=0; this.mode='house'; this.fr=false; this.eat=false; this.rt=this.i*60;}
  step(p){
    this.mp+=0.05*(this.fr?0.5:this.eat?1.5:1); if(this.mp<1)return; this.mp=0;
    if(this.mode==='house'){this.rt--; if(this.rt<=0){this.mode='chase'; this.y=11; this.x=14;} return;}
    
    this.x=(this.x+this.dir.x+C)%C; this.y+=this.dir.y;
    if(this.eat && this.x===14 && this.y===14){this.eat=false; this.fr=false; this.mode='chase';}

    const va=[]; const opp={x:-this.dir.x, y:-this.dir.y};
    for(const d of DIRS){
      let nx=(this.x+d.x+C)%C, ny=this.y+d.y;
      if(ny>=0 && ny<R && map[ny][nx]!==1) { if(d.x!==opp.x || d.y!==opp.y) va.push(d); }
    }
    if(!va.length) {this.dir=opp; return;}

    // A* logic for targeting
    let target = this.eat ? {x:14,y:14} : this.fr ? {x:this.x+(this.x-p.x), y:this.y+(this.y-p.y)} : {x:p.x,y:p.y};
    let nextMove = astar(this.x, this.y, target.x, target.y);
    this.dir = nextMove || va[Math.floor(Math.random()*va.length)];
  }
}

let interceptors=[new Interceptor(0,'#f44'), new Interceptor(1,'#4f4'), new Interceptor(2,'#48f'), new Interceptor(3,'#f84')];

function drawDrone(x, y, color, isFr) {
  const cx=x*T+T/2, cy=y*T+T/2;
  ctx.fillStyle = isFr ? (af%20<10?'#fff':'#00f') : color;
  ctx.fillRect(cx-6, cy-4, 12, 8); 
  ctx.strokeStyle = '#fff';
  const rotSize = 5, rotAng = af * 0.5;
  [[-1,-1],[1,-1],[-1,1],[1,1]].forEach(([dx,dy])=>{
    ctx.beginPath(); ctx.moveTo(cx+dx*7-Math.cos(rotAng)*5, cy+dy*7-Math.sin(rotAng)*5);
    ctx.lineTo(cx+dx*7+Math.cos(rotAng)*5, cy+dy*7+Math.sin(rotAng)*5); ctx.stroke();
  });
}

function update(){
  if(gs !== 'playing') return; af++;
  if(!scout.moving){
    if(map[scout.y]?.[(scout.x+scout.want.x+C)%C]!==1){scout.dir={...scout.want}; scout.moving=true;}
    else if(map[scout.y]?.[(scout.x+scout.dir.x+C)%C]!==1) scout.moving=true;
  }
  if(scout.moving){
    scout.tick++; if(scout.tick>=7){
      scout.x=(scout.x+scout.dir.x+C)%C; scout.y+=scout.dir.y; scout.moving=false; scout.tick=0;
      const t=map[scout.y]?.[scout.x];
      if(t===2){map[scout.y][scout.x]=0; score+=10; dotsEaten++;}
      else if(t===3){map[scout.y][scout.x]=0; score+=50; frightT=400; interceptors.forEach(g=>g.fr=true);}
    }
  }
  if(frightT>0){frightT--; if(frightT<=0)interceptors.forEach(g=>g.fr=false);}
  interceptors.forEach(g=>{
    g.step(scout);
    if(!g.eat && g.x===scout.x && g.y===scout.y){
      if(g.fr){g.eat=true; g.fr=false; score+=200;}
      else {lives--; if(lives<=0)gs='menu'; else startGame(true);}
    }
  });
  document.getElementById('score').textContent=score;
  document.getElementById('lives-display').textContent='â–²'.repeat(Math.max(0,lives));
}

function draw(){
  ctx.fillStyle='#05050a'; ctx.fillRect(0,0,canvas.width,canvas.height);
  for(let r=0;r<R;r++)for(let c=0;c<C;c++){
    const t=map[r][c];
    if(t===1){ctx.fillStyle='#112'; ctx.fillRect(c*T+2,r*T+2,T-4,T-4);}
    else if(t===2){ctx.fillStyle='#0ff'; ctx.beginPath(); ctx.arc(c*T+T/2,r*T+T/2,2,0,7); ctx.fill();}
    else if(t===3){ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(c*T+T/2,r*T+T/2,5,0,7); ctx.fill();}
  }
  drawDrone(scout.x, scout.y, '#ff0', false);
  interceptors.forEach(g=>drawDrone(g.x, g.y, g.eat?'#333':g.col, g.fr));
}

function startGame(k=false){
  if(!k){score=0; lives=3; initMap(); dotsEaten=0;}
  scout={x:14,y:23,dir:{x:0,y:0},want:{x:-1,y:0},tick:0,moving:false};
  interceptors.forEach(g=>g.reset());
  document.getElementById('overlay').classList.add('hidden'); gs='playing';
}

window.addEventListener('keydown', (e)=>{
  unlockAudio(); if(gs==='menu' && e.key==='Enter') startGame();
  let d=null;
  if(e.key==='ArrowUp') d={x:0,y:-1}; else if(e.key==='ArrowDown') d={x:0,y:1};
  else if(e.key==='ArrowLeft') d={x:-1,y:0}; else if(e.key==='ArrowRight') d={x:1,y:0};
  if(d){e.preventDefault(); scout.want=d; scout.pending=true;}
});

document.getElementById('overlay').addEventListener('click', ()=>{unlockAudio(); if(gs==='menu') startGame();});

function loop(){update(); draw(); requestAnimationFrame(loop);}
initMap(); loop();
</script>
</body>
</html>