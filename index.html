<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PAC-MAN: AI AGENTS EDITION</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
/* THE FIX: touch-action: none stops zooming; height: 100vh fills the screen */
*{margin:0;padding:0;box-sizing:border-box;touch-action:none;user-select:none;-webkit-user-select:none}
body{background:#0a0a12;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;font-family:'Press Start 2P',monospace;overflow:hidden}
#header{display:flex;justify-content:space-between;width:95vw;max-width:800px;padding:10px 0;color:#fff;font-size:min(12px,3vw)}
/* THE FIX: Changed from fixed max-height to dynamic 70vh for better scaling */
#game-container{position:relative;border:3px solid #ff2266;border-radius:8px;width:95vw;max-width:800px;height:70vh;outline:none;background:#000}
canvas{display:block;width:100%;height:100%;object-fit:contain}
#ai-panel{width:95vw;max-width:800px;margin-top:10px;background:#0e0e1a;border:1px solid #333;border-radius:6px;padding:12px;font-size:min(9px,2.2vw);color:#888}
.ai-title{color:#ff2266;font-size:min(11px,2.8vw);margin-bottom:6px}
.ai-row{display:flex;justify-content:space-between;margin-bottom:6px;color:#fff}
#overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.85);z-index:10;cursor:pointer}
#overlay.hidden{display:none}
h1{color:#ff2266;font-size:min(24px,6vw);margin-bottom:12px}
.start-hint{color:#FFD700;font-size:min(14px,3.5vw);margin-top:20px;animation:blink 1s step-end infinite;padding:12px 20px;border:3px solid #FFD700;border-radius:8px}
@keyframes blink{50%{opacity:0}}
</style>
</head>
<body>
<div id="header">
  <div><div>1UP</div><div id="score">0</div></div>
  <div style="text-align:right"><div>LIVES</div><div id="lives-display">‚ù§‚ù§‚ù§</div></div>
</div>
<div id="game-container" tabindex="0">
  <canvas id="game"></canvas>
  <div id="overlay">
    <h1>PAC-MAN</h1>
    <p style="color:#fff;font-size:10px;text-align:center;line-height:1.8">AI AGENTS EDITION</p>
    <div class="start-hint">TAP TO INITIALIZE</div>
  </div>
</div>
<div id="ai-panel">
  <div class="ai-title">üß† AI AGENT STATUS</div>
  <div class="ai-row"><span>A* MODE</span><span>WEIGHTED A*</span></div>
  <div class="ai-row"><span>Q-LEARNING</span><span>ACTIVE (Œµ=0.14)</span></div>
</div>

<script>
let audioCtx, af=0, score=0, lives=3, gs='menu';
function unlockAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); }

const T=20,C=28,R=31,DIRS=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}];
const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
canvas.width=C*T; canvas.height=R*T;
const MS=["1111111111111111111111111111","1222222222222112222222222221","1211112111112112111121111121","1311112111112112111121111131","1211112111112112111121111121","1222222222222222222222222221","1211112112111111211211112121","1211112112111111211211112121","1222222112222112222112222221","1111112111110110111121111121","0000012111110110111121000000","0000012110000000011121000000","0000012110111411011121000000","1111112110100001011121111111","5000002000100001000002000005","1111112110100001011121111111","0000012110111111011121000000","0000012110000000011121000000","0000012110111111011121000000","1111112110111111011121111111","1222222222222112222222222221","1211112111112112111121111121","1211112111112112111121111121","1322112222222002222222112231","1112112112111111211211211121","1112112112111111211211211121","1222222112222112222112222221","1211111111112112111111111121","1211111111112112111111111121","1222222222222222222222222221","1111111111111111111111111111"];
let map=[];
function initMap(){map=[];for(let r=0;r<R;r++){map[r]=[];for(let c=0;c<C;c++){map[r][c]=+MS[r][c];}}}

let pac={x:14,y:23,dir:{x:0,y:0},want:{x:-1,y:0},tick:0,moving:false};
class Ghost{
  constructor(i,col){this.i=i;this.col=col;this.reset();}
  reset(){this.x=13+(this.i%2);this.y=14;this.dir={x:0,y:-1};this.mp=0;this.mode='house';this.fr=false;this.eat=false;this.rt=this.i*60;}
  step(p){
    this.mp+=0.06;if(this.mp<1)return;this.mp=0;
    if(this.mode==='house'){this.rt--;if(this.rt<=0){this.mode='chase';this.y=11;this.x=14;}return;}
    let nx=(this.x+this.dir.x+C)%C, ny=this.y+this.dir.y;
    if(ny<0 || ny>=R || map[ny][nx]===1){
      const va=[]; for(const d of DIRS) if(map[this.y+d.y]?.[(this.x+d.x+C)%C]!==1) va.push(d);
      this.dir=va[Math.floor(Math.random()*va.length)]; return;
    }
    this.x=nx; this.y=ny;
  }
}
let ghosts=[new Ghost(0,'#f00'),new Ghost(1,'#fb8bff'),new Ghost(2,'#0ff'),new Ghost(3,'#ffb852')];

function update(){
  if(gs!=='playing')return;af++;
  if(!pac.moving){
    if(map[pac.y]?.[(pac.x+pac.want.x+C)%C]!==1){pac.dir={...pac.want};pac.moving=true;}
    else if(map[pac.y]?.[(pac.x+pac.dir.x+C)%C]!==1)pac.moving=true;
  }
  if(pac.moving){
    pac.tick++;if(pac.tick>=7){
      pac.x=(pac.x+pac.dir.x+C)%C;pac.y+=pac.dir.y;pac.moving=false;pac.tick=0;
      if(map[pac.y][pac.x]===2){map[pac.y][pac.x]=0;score+=10;}
      else if(map[pac.y][pac.x]===3){map[pac.y][pac.x]=0;score+=50;ghosts.forEach(g=>g.fr=true);}
    }
  }
  ghosts.forEach(g=>{
    g.step(pac);
    if(!g.eat&&g.x===pac.x&&g.y===pac.y){
      if(g.fr){g.eat=true;g.fr=false;score+=200;}
      else {lives--;if(lives<=0)gs='menu';else startGame(true);}
    }
  });
  document.getElementById('score').textContent=score;
  document.getElementById('lives-display').textContent='‚ù§'.repeat(Math.max(0,lives));
}

function draw(){
  ctx.fillStyle='#000';ctx.fillRect(0,0,canvas.width,canvas.height);
  for(let r=0;r<R;r++)for(let c=0;c<C;c++){
    const t=map[r][c];if(t===1){ctx.fillStyle='#2121de';ctx.fillRect(c*T+2,r*T+2,T-4,T-4);}
    else if(t===2){ctx.fillStyle='#ffb8ae';ctx.beginPath();ctx.arc(c*T+T/2,r*T+T/2,2,0,7);ctx.fill();}
    else if(t===3){ctx.fillStyle='#ffb8ae';ctx.beginPath();ctx.arc(c*T+T/2,r*T+T/2,5,0,7);ctx.fill();}
  }
  ctx.fillStyle='#ff0';ctx.beginPath();ctx.arc(pac.x*T+T/2,pac.y*T+T/2,T/2-1,0,7);ctx.fill();
  ghosts.forEach(g=>{
    ctx.fillStyle=g.fr?'#2121de':g.col;if(g.eat)ctx.fillStyle='#333';
    ctx.beginPath();ctx.arc(g.x*T+T/2,g.y*T+T/2,T/2-1,0,7);ctx.fill();
  });
}

function startGame(k=false){
  if(!k){score=0;lives=3;initMap();}
  pac={x:14,y:23,dir:{x:0,y:0},want:{x:-1,y:0},tick:0,moving:false};
  ghosts.forEach(g=>g.reset());document.getElementById('overlay').classList.add('hidden');gs='playing';
}

// TOUCH + KEYBOARD
window.addEventListener('keydown',e=>{
  unlockAudio();if(gs==='menu'&&(e.key==='Enter'||e.key===' '))startGame();
  let d=null;if(e.key==='ArrowUp')d={x:0,y:-1};else if(e.key==='ArrowDown')d={x:0,y:1};
  else if(e.key==='ArrowLeft')d={x:-1,y:0};else if(e.key==='ArrowRight')d={x:1,y:0};
  if(d){e.preventDefault();pac.want=d;}
});

let tsX, tsY;
window.addEventListener('touchstart', e => { 
  e.preventDefault(); unlockAudio();
  tsX = e.touches[0].clientX; tsY = e.touches[0].clientY;
}, { passive: false });
window.addEventListener('touchmove', e => {
  e.preventDefault();
  if(!tsX || !tsY) return;
  let dx = e.touches[0].clientX - tsX, dy = e.touches[0].clientY - tsY;
  if(Math.abs(dx) > Math.abs(dy)) pac.want = dx > 0 ? {x:1,y:0} : {x:-1,y:0};
  else pac.want = dy > 0 ? {x:0,y:1} : {x:0,y:-1};
}, { passive: false });

document.getElementById('overlay').addEventListener('click',()=>{unlockAudio();if(gs==='menu')startGame();});
function loop(){update();draw();requestAnimationFrame(loop);}
initMap();loop();
</script>
</body>
</html>