<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DRONE-NAV: DATA RECOVERY</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
*{margin:0;padding:0;box-sizing:border-box;touch-action:none;user-select:none;-webkit-user-select:none}
body{background:#05050a;display:flex;flex-direction:column;align-items:center;min-height:100vh;font-family:'Press Start 2P',monospace;overflow:hidden;padding:10px 0}
#header{display:flex;justify-content:space-between;width:min(560px,96vw);padding:8px 0;color:#0ff;font-size:min(10px,2.2vw)}
.score-value{color:#fff;margin-top:3px}
#game-container{position:relative;border:2px solid #0ff;border-radius:8px;width:min(560px,96vw);max-height:62vh;aspect-ratio:28/31;background:#000}
canvas{display:block;width:100%;height:100%}
#overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.9);z-index:10;border-radius:6px}
#overlay.hidden{display:none}
h1{color:#0ff;font-size:min(18px,5vw);margin-bottom:10px;text-align:center;text-shadow:0 0 10px #0ff}
.subtitle{color:#fff;font-size:min(8px,2vw);margin-bottom:20px;letter-spacing:1px}
.start-hint{color:#0f0;font-size:min(12px,3vw);margin-top:20px;animation:blink 1s step-end infinite;padding:12px 20px;border:2px solid #0f0;border-radius:8px}
#ready-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#0f0;font-size:16px;z-index:5;display:none}
#touch-controls{display:none;justify-content:center;margin-top:10px;width:100%}
.d-pad{display:grid;grid-template-areas:". up ." "left . right" ". down .";gap:10px}
.d-pad button{width:60px;height:60px;background:#111;border:2px solid #0ff;border-radius:12px;color:#0ff;font-size:20px;display:flex;align-items:center;justify-content:center}
@media(pointer:coarse){#touch-controls{display:flex}}
@keyframes blink{50%{opacity:0}}
.diff-buttons{display:flex;gap:8px;justify-content:center;margin-top:10px}
.diff-btn{font-family:'Press Start 2P',monospace;font-size:8px;padding:8px;border:1px solid #444;background:#111;color:#888}
.diff-btn.selected{border-color:#0f0;color:#0f0}
</style>
</head>
<body>
<div id="header">
  <div><div>PACKETS</div><div class="score-value" id="score">0</div></div>
  <div style="text-align:center"><div>MAX DATA</div><div class="score-value" id="high-score">0</div></div>
  <div style="text-align:right"><div>HULLS</div><div class="score-value" id="lives-display"></div></div>
</div>
<div id="game-container">
  <canvas id="game"></canvas>
  <div id="overlay">
    <h1>DRONE-NAV<br>DATA-GEN</h1>
    <div class="subtitle">AUTONOMOUS SCOUT SIMULATION</div>
    <div class="diff-buttons">
      <button class="diff-btn selected" data-diff="easy">LOW RISK</button>
      <button class="diff-btn" data-diff="medium">STABLE</button>
      <button class="diff-btn" data-diff="hard">HIGH RISK</button>
    </div>
    <div class="start-hint" id="start-trigger">INITIALIZE SCOUT</div>
  </div>
  <div id="ready-text">CALIBRATING...</div>
</div>
<div id="touch-controls">
  <div class="d-pad">
    <button id="btn-up" style="grid-area:up">▲</button>
    <button id="btn-left" style="grid-area:left">◀</button>
    <button id="btn-right" style="grid-area:right">▶</button>
    <button id="btn-down" style="grid-area:down">▼</button>
  </div>
</div>

<script>
let audioCtx, af=0;
function unlockAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}
window.addEventListener('touchstart', unlockAudio, { once: true });

function tone(f,dur,type='sine',vol=0.1){
  if(!audioCtx) return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.type=type; o.frequency.setValueAtTime(f,audioCtx.currentTime);
  g.gain.setValueAtTime(vol,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+dur);
  o.start(); o.stop(audioCtx.currentTime+dur);
}

const T=20,C=28,R=31,DIRS=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}];
const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
canvas.width=C*T; canvas.height=R*T;
const MS=["1111111111111111111111111111","1222222222222112222222222221","1211112111112112111121111121","1311112111112112111121111131","1211112111112112111121111121","1222222222222222222222222221","1211112112111111211211112121","1211112112111111211211112121","1222222112222112222112222221","1111112111110110111121111121","0000012111110110111121000000","0000012110000000011121000000","0000012110111411011121000000","1111112110100001011121111111","5000002000100001000002000005","1111112110100001011121111111","0000012110111111011121000000","0000012110000000011121000000","0000012110111111011121000000","1111112110111111011121111111","1222222222222112222222222221","1211112111112112111121111121","1211112111112112111121111121","1322112222222002222222112231","1112112112111111211211211121","1112112112111111211211211121","1222222112222112222112222221","1211111111112112111111111121","1211111111112112111111111121","1222222222222222222222222221","1111111111111111111111111111"];

let map=[],totalDots=0,dotsEaten=0,score=0,hi=+(localStorage.getItem('drone_hi')||'0'),lives=3,gs='menu',frightT=0,selDiff='easy';
const PRE={easy:{lives:5,gSpd:.04,fD:600},medium:{lives:3,gSpd:.055,fD:400},hard:{lives:2,gSpd:.07,fD:250}};
let diff={...PRE.easy};

function initMap(){map=[];totalDots=0;dotsEaten=0;for(let r=0;r<R;r++){map[r]=[];for(let c=0;c<C;c++){map[r][c]=+MS[r][c];if(map[r][c]===2||map[r][c]===3)totalDots++;}}}
function ok(x,y){return x<0||x>=C?true:y<0||y>=R?false:map[y][x]!==1;}
function gok(x,y,m,e){if(x<0||x>=C)return true;if(y<0||y>=R)return false;if(map[y][x]===1)return false;return !(map[y][x]===4&&m!=='house'&&!e);}

let scout={x:14,y:23,dir:{x:0,y:0},want:{x:-1,y:0},tick:0,moving:false,pending:false};
class Agent {
  constructor(i, col){this.i=i; this.col=col; this.reset();}
  reset(){this.x=14; this.y=14; this.dir={x:0,y:-1}; this.mp=0; this.mode='house'; this.fr=false; this.eat=false; this.rt=this.i*80;}
  step(p){
    this.mp+=diff.gSpd*(this.fr?.5:this.eat?1.5:1); if(this.mp<1)return; this.mp=0;
    this.x=(this.x+this.dir.x+C)%C; this.y+=this.dir.y;
    if(this.eat && this.x===14 && this.y===14){this.eat=false;this.fr=false;}
    const opp={x:-this.dir.x, y:-this.dir.y}, va=[];
    for(const d of DIRS){if(d.x===opp.x&&d.y===opp.y)continue; if(gok((this.x+d.x+C)%C,this.y+d.y,this.mode,this.eat))va.push(d);}
    if(!va.length){this.dir=opp; return;}
    let bd=1e9, best=va[0], tx=this.fr?this.x+(this.x-p.x):this.eat?14:p.x, ty=this.fr?this.y+(this.y-p.y):this.eat?14:p.y;
    if(this.mode==='house'){this.rt--;if(this.rt<=0)this.mode='chase';}
    for(const d of va){const dx=((this.x+d.x+C)%C)-tx, dy=this.y+d.y-ty, dist=dx*dx+dy*dy; if(dist<bd){bd=dist;best=d;}}
    this.dir=best;
  }
}
let agents=[new Agent(0,'#f44'), new Agent(1,'#4f4'), new Agent(2,'#48f'), new Agent(3,'#f84')];

function drawStar(cx, cy, spikes, outerRadius, innerRadius, color) {
  let rot = Math.PI / 2 * 3, x = cx, y = cy, step = Math.PI / spikes;
  ctx.beginPath(); ctx.moveTo(cx, cy - outerRadius);
  for (let i = 0; i < spikes; i++) {
    x = cx + Math.cos(rot) * outerRadius; y = cy + Math.sin(rot) * outerRadius;
    ctx.lineTo(x, y); rot += step;
    x = cx + Math.cos(rot) * innerRadius; y = cy + Math.sin(rot) * innerRadius;
    ctx.lineTo(x, y); rot += step;
  }
  ctx.lineTo(cx, cy - outerRadius); ctx.closePath();
  ctx.fillStyle = color; ctx.fill();
}

function drawDrone(x, y, color) {
  const cx=x*T+T/2, cy=y*T+T/2;
  ctx.fillStyle = color; ctx.fillRect(cx-6, cy-4, 12, 8); // Chassis
  ctx.strokeStyle = '#fff'; ctx.lineWidth = 1;
  const rotSize = 5, rotOff = 7, rotAng = af * 0.5;
  [[-1,-1],[1,-1],[-1,1],[1,1]].forEach(([dx,dy])=>{
    ctx.beginPath();
    ctx.moveTo(cx+dx*rotOff-Math.cos(rotAng)*rotSize, cy+dy*rotOff-Math.sin(rotAng)*rotSize);
    ctx.lineTo(cx+dx*rotOff+Math.cos(rotAng)*rotSize, cy+dy*rotOff+Math.sin(rotAng)*rotSize);
    ctx.stroke(); // Spinning Rotors
  });
}

function update(){
  if(gs !== 'playing') return;
  af++;
  if(!scout.moving && scout.pending){
    if(ok((scout.x+scout.want.x+C)%C, scout.y+scout.want.y)){scout.dir={...scout.want}; scout.moving=true; scout.pending=false;}
    else if(ok((scout.x+scout.dir.x+C)%C, scout.y+scout.dir.y)) scout.moving=true;
  }
  if(scout.moving){
    scout.tick++; if(scout.tick>=7){
      scout.x=(scout.x+scout.dir.x+C)%C; scout.y+=scout.dir.y; scout.moving=false; scout.tick=0;
      const t=map[scout.y]?.[scout.x];
      if(t===2){map[scout.y][scout.x]=0; score+=10; dotsEaten++; tone(800,.05);}
      else if(t===3){map[scout.y][scout.x]=0; score+=50; frightT=diff.fD; agents.forEach(g=>g.fr=true); tone(400,.1,'triangle');}
    }
  }
  if(frightT>0){frightT--; if(frightT<=0)agents.forEach(g=>g.fr=false);}
  agents.forEach(g=>{
    g.step(scout);
    if(!g.eat && g.x===scout.x && g.y===scout.y){
      if(g.fr){g.eat=true; g.fr=false; score+=200; tone(1000,.1);}
      else {lives--; tone(100,.3,'sawtooth'); if(lives<=0)gs='menu'; else startGame(true);}
    }
  });
  if(dotsEaten>=totalDots){gs='menu'; localStorage.setItem('drone_hi', Math.max(score, hi));}
  document.getElementById('score').textContent=score;
  document.getElementById('lives-display').textContent='▲'.repeat(Math.max(0,lives));
}

function draw(){
  ctx.fillStyle='#05050a'; ctx.fillRect(0,0,canvas.width,canvas.height);
  for(let r=0;r<R;r++)for(let c=0;c<C;c++){
    const t=map[r][c];
    if(t===1){ctx.fillStyle='#112'; ctx.fillRect(c*T+2,r*T+2,T-4,T-4);}
    else if(t===2) drawStar(c*T+T/2, r*T+T/2, 5, 3, 1.5, '#0ff'); // Data Star
    else if(t===3) drawStar(c*T+T/2, r*T+T/2, 5, 7, 3.5, (af%20<10?'#fff':'#0f0')); // System Core
  }
  drawDrone(scout.x, scout.y, '#ff0');
  agents.forEach(g=>drawDrone(g.x, g.y, g.fr?'#fff':g.col));
}

function startGame(k=false){
  if(!k){score=0; lives=PRE[selDiff].lives; diff={...PRE[selDiff]}; initMap(); dotsEaten=0;}
  scout={x:14,y:23,dir:{x:0,y:0},want:{x:-1,y:0},tick:0,moving:false};
  agents.forEach(g=>g.reset());
  document.getElementById('overlay').classList.add('hidden'); gs='playing';
}

function setD(dx,dy){scout.want={x:dx,y:dy}; scout.pending=true; unlockAudio();}
document.getElementById('btn-up').addEventListener('touchstart', (e)=>{e.preventDefault(); setD(0,-1);});
document.getElementById('btn-down').addEventListener('touchstart', (e)=>{e.preventDefault(); setD(0,1);});
document.getElementById('btn-left').addEventListener('touchstart', (e)=>{e.preventDefault(); setD(-1,0);});
document.getElementById('btn-right').addEventListener('touchstart', (e)=>{e.preventDefault(); setD(1,0);});
document.getElementById('start-trigger').addEventListener('touchstart', (e)=>{e.preventDefault(); startGame();});
document.querySelectorAll('.diff-btn').forEach(b=>{
  b.addEventListener('touchstart', (e)=>{
    e.preventDefault(); document.querySelectorAll('.diff-btn').forEach(x=>x.classList.remove('selected'));
    b.classList.add('selected'); selDiff=b.dataset.diff;
  });
});

function loop(){update(); draw(); requestAnimationFrame(loop);}
initMap(); loop();
</script>
</body>
</html>