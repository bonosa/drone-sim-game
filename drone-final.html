<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DRONE-NAV: AGENT EVASION</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
*{margin:0;padding:0;box-sizing:border-box;touch-action:none;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
body{background:#05050a;display:flex;flex-direction:column;align-items:center;min-height:100vh;font-family:'Press Start 2P',monospace;overflow:hidden;padding:10px 0}
#header{display:flex;justify-content:space-between;width:min(560px,96vw);padding:8px 0;color:#0ff;font-size:min(10px,2.2vw)}
.score-value{color:#fff;margin-top:3px}
#game-container{position:relative;border:2px solid #0ff;border-radius:8px;width:min(560px,96vw);max-height:62vh;aspect-ratio:28/31}
canvas{display:block;width:100%;height:100%}
#overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.9);z-index:10;border-radius:6px}
#overlay.hidden{display:none}
h1{color:#0ff;font-size:min(18px,5vw);margin-bottom:10px;text-align:center}
.subtitle{color:#fff;font-size:min(8px,2vw);margin-bottom:20px;letter-spacing:1px}
.start-hint{color:#0f0;font-size:min(12px,3vw);margin-top:20px;animation:blink 1s step-end infinite;padding:12px 20px;border:2px solid #0f0;border-radius:8px}
#ready-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#0f0;font-size:16px;z-index:5;display:none}
#touch-controls{display:none;justify-content:center;margin-top:10px;width:100%}
.d-pad{display:grid;grid-template-areas:". up ." "left . right" ". down .";gap:10px}
.d-pad button{width:60px;height:60px;background:#111;border:2px solid #0ff;border-radius:12px;color:#0ff;font-size:20px;display:flex;align-items:center;justify-content:center}
.d-pad button:active{background:#0ff;color:#000}
.d-pad .up{grid-area:up}.d-pad .down{grid-area:down}.d-pad .left{grid-area:left}.d-pad .right{grid-area:right}
@media(pointer:coarse){#touch-controls{display:flex}}
@keyframes blink{50%{opacity:0}}
#diff-select{text-align:center;margin-bottom:10px}
.diff-buttons{display:flex;gap:8px;justify-content:center;margin-top:10px}
.diff-btn{font-family:'Press Start 2P',monospace;font-size:8px;padding:8px;border:1px solid #444;background:#111;color:#888}
.diff-btn.selected{border-color:#0f0;color:#0f0}
</style>
</head>
<body>
<div id="header">
  <div><div>PACKETS</div><div class="score-value" id="score">0</div></div>
  <div style="text-align:center"><div>MAX DATA</div><div class="score-value" id="high-score">0</div></div>
  <div style="text-align:right"><div>CHASSIS</div><div class="score-value" id="lives-display"></div></div>
</div>
<div id="game-container">
  <canvas id="game"></canvas>
  <div id="overlay">
    <h1>DRONE-NAV<br>SYSTEMS</h1>
    <div class="subtitle">AUTONOMOUS AGENT TESTING</div>
    <div id="diff-select">
      <div class="diff-buttons">
        <button class="diff-btn selected" data-diff="easy">LOW RISK</button>
        <button class="diff-btn" data-diff="medium">STABLE</button>
        <button class="diff-btn" data-diff="hard">HIGH RISK</button>
      </div>
    </div>
    <div class="start-hint" id="start-trigger">INITIALIZE DRONE</div>
  </div>
  <div id="ready-text">CALIBRATING...</div>
</div>
<div id="touch-controls">
  <div class="d-pad">
    <button class="up" id="btn-up">▲</button>
    <button class="left" id="btn-left">◀</button>
    <button class="right" id="btn-right">▶</button>
    <button class="down" id="btn-down">▼</button>
  </div>
</div>

<script>
let audioCtx;
function unlockAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}
window.addEventListener('touchstart', unlockAudio, { once: true });

function tone(f,dur,type='sine',vol=0.1){
  if(!audioCtx) return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.type=type; o.frequency.setValueAtTime(f,audioCtx.currentTime);
  g.gain.setValueAtTime(vol,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+dur);
  o.start(); o.stop(audioCtx.currentTime+dur);
}

const T=20,C=28,R=31,DIRS=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}];
const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
canvas.width=C*T; canvas.height=R*T;
const MS=["1111111111111111111111111111","1222222222222112222222222221","1211112111112112111121111121","1311112111112112111121111131","1211112111112112111121111121","1222222222222222222222222221","1211112112111111211211112121","1211112112111111211211112121","1222222112222112222112222221","1111112111110110111121111121","0000012111110110111121000000","0000012110000000011121000000","0000012110111411011121000000","1111112110100001011121111111","5000002000100001000002000005","1111112110100001011121111111","0000012110111111011121000000","0000012110000000011121000000","0000012110111111011121000000","1111112110111111011121111111","1222222222222112222222222221","1211112111112112111121111121","1211112111112112111121111121","1322112222222002222222112231","1112112112111111211211211121","1112112112111111211211211121","1222222112222112222112222221","1211111111112112111111111121","1211111111112112111111111121","1222222222222222222222222221","1111111111111111111111111111"];

let map=[],totalDots=0,dotsEaten=0;
function initMap(){map=[];totalDots=0;dotsEaten=0;for(let r=0;r<R;r++){map[r]=[];for(let c=0;c<C;c++){map[r][c]=+MS[r][c];if(map[r][c]===2||map[r][c]===3)totalDots++;}}}
function ok(x,y){if(x<0||x>=C)return true;if(y<0||y>=R)return false;return map[y][x]!==1;}
function gok(x,y,m,e){if(x<0||x>=C)return true;if(y<0||y>=R)return false;if(map[y][x]===1)return false;if(map[y][x]===4&&m!=='house'&&!e)return false;return true;}
function wx(x){return x<0?C-1:x>=C?0:x;}

let score=0,hi=+(localStorage.getItem('drone_hi')||'0'),lives=3,gs='menu',af=0,frightT=0,readyT=0,selDiff='easy';
document.getElementById('high-score').textContent=hi;

const PRE={easy:{lives:5,gSpd:.04,frightD:600},medium:{lives:3,gSpd:.055,frightD:400},hard:{lives:2,gSpd:.07,frightD:250}};
let diff={...PRE.easy};

let pac={x:14,y:23,dir:{x:0,y:0},want:{x:-1,y:0},tick:0,moving:false,pendingMove:false};
class Agent {
  constructor(i, col){this.i=i; this.col=col; this.reset();}
  reset(){this.x=14; this.y=14; this.dir={x:0,y:-1}; this.mp=0; this.mode=this.i===0?'chase':'house'; this.fr=false; this.eat=false; this.rt=this.i*80;}
  step(p){
    this.mp+=diff.gSpd*(this.fr?.5:this.eat?1.5:1); if(this.mp<1)return; this.mp=0;
    this.x=wx(this.x+this.dir.x); this.y+=this.dir.y;
    if(this.eat && this.x===14 && this.y===14){this.eat=false;this.fr=false;}
    const opp={x:-this.dir.x, y:-this.dir.y}, va=[];
    for(const d of DIRS){if(d.x===opp.x&&d.y===opp.y)continue; if(gok(wx(this.x+d.x),this.y+d.y,this.mode,this.eat))va.push(d);}
    if(!va.length){this.dir=opp; return;}
    let bd=1e9, best=va[0], tx=this.fr?this.x+(this.x-p.x):this.eat?14:p.x, ty=this.fr?this.y+(this.y-p.y):this.eat?14:p.y;
    for(const d of va){const dx=wx(this.x+d.x)-tx, dy=this.y+d.y-ty, dist=dx*dx+dy*dy; if(dist<bd){bd=dist;best=d;}}
    this.dir=best;
  }
}
let agents=[new Agent(0,'#f44'), new Agent(1,'#4f4'), new Agent(2,'#48f'), new Agent(3,'#f84')];

function drawDrone(x, y, color) {
  const cx=x*T+T/2, cy=y*T+T/2;
  ctx.fillStyle = color;
  ctx.fillRect(cx-6, cy-4, 12, 8); // Chassis
  ctx.strokeStyle = '#fff';
  ctx.lineWidth = 1;
  const rotSize = 5, rotOff = 7, rotAng = af * 0.5;
  [[-1,-1],[1,-1],[-1,1],[1,1]].forEach(([dx,dy])=>{
    ctx.beginPath();
    ctx.moveTo(cx+dx*rotOff-Math.cos(rotAng)*rotSize, cy+dy*rotOff-Math.sin(rotAng)*rotSize);
    ctx.lineTo(cx+dx*rotOff+Math.cos(rotAng)*rotSize, cy+dy*rotOff+Math.sin(rotAng)*rotSize);
    ctx.stroke(); // Rotors
  });
  ctx.fillStyle = '#000';
  ctx.fillRect(cx-3, cy-2, 2, 2); // Sensors
}

function pacStep(){
  if(pac.pendingMove && !pac.moving){
    if(ok(wx(pac.x+pac.want.x), pac.y+pac.want.y)){pac.dir={...pac.want}; pac.moving=true; pac.pendingMove=false;}
    else if(ok(wx(pac.x+pac.dir.x), pac.y+pac.dir.y)){pac.moving=true; pac.pendingMove=false;}
  }
  if(!pac.moving)return false;
  pac.tick++; if(pac.tick>=7){pac.x=wx(pac.x+pac.dir.x); pac.y+=pac.dir.y; pac.moving=false; pac.tick=0; return true;}
  return false;
}

function collide(){
  for(const g of agents){
    if(g.eat)continue;
    if(g.x===pac.x && g.y===pac.y){
      if(g.fr){g.eat=true; g.fr=false; score+=200; tone(800,.1);}
      else {lives--; tone(150,.3,'sawtooth'); if(lives<=0)gs='menu'; else startGame(true); return true;}
    }
  } return false;
}

function setDir(dx,dy){pac.want={x:dx,y:dy}; pac.pendingMove=true; unlockAudio();}
Object.entries({'btn-up':{x:0,y:-1},'btn-down':{x:0,y:1},'btn-left':{x:-1,y:0},'btn-right':{x:1,y:0}}).forEach(([id,d])=>{
  document.getElementById(id).addEventListener('touchstart', (e)=>{e.preventDefault(); setDir(d.x,d.y);});
});
document.getElementById('start-trigger').addEventListener('touchstart', (e)=>{e.preventDefault(); startGame();});

function startGame(keepScore=false){
  if(!keepScore){score=0; lives=PRE[selDiff].lives; diff={...PRE[selDiff]}; initMap();}
  pac={x:14,y:23,dir:{x:0,y:0},want:{x:-1,y:0},tick:0,moving:false};
  agents.forEach(g=>g.reset());
  document.getElementById('overlay').classList.add('hidden');
  gs='playing'; updateUI();
}

function updateUI(){
  document.getElementById('score').textContent=score;
  document.getElementById('high-score').textContent=Math.max(score,hi);
  document.getElementById('lives-display').textContent='▲'.repeat(lives);
}

function loop(){
  if(gs === 'playing'){
    af++;
    if(pacStep()){
      const t=map[pac.y]?.[pac.x];
      if(t===2){map[pac.y][pac.x]=0; score+=10; dotsEaten++; tone(600,.05);}
      else if(t===3){map[pac.y][pac.x]=0; score+=50; frightT=diff.frightD; agents.forEach(g=>g.fr=true);}
      if(collide())return;
      if(dotsEaten>=totalDots){gs='menu'; showOv('COMPLETE','SYSTEM REBOOT');}
    }
    if(frightT>0){frightT--; if(frightT<=0)agents.forEach(g=>g.fr=false);}
    agents.forEach(g=>g.step(pac));
    collide(); updateUI();
  }
  ctx.fillStyle='#05050a'; ctx.fillRect(0,0,canvas.width,canvas.height);
  for(let r=0;r<R;r++)for(let c=0;c<C;c++){
    if(map[r][c]===1){ctx.fillStyle='#112'; ctx.fillRect(c*T+2,r*T+2,T-4,T-4);}
    else if(map[r][c]===2){ctx.fillStyle='#0ff'; ctx.beginPath(); ctx.arc(c*T+T/2,r*T+T/2,2,0,7); ctx.fill();}
    else if(map[r][c]===3){ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(c*T+T/2,r*T+T/2,5,0,7); ctx.fill();}
  }
  drawDrone(pac.x, pac.y, '#ff0');
  agents.forEach(g=>drawDrone(g.x, g.y, g.fr?'#fff':g.col));
  requestAnimationFrame(loop);
}

function showOv(t,h){
  const o=document.getElementById('overlay'); o.classList.remove('hidden');
  o.querySelector('h1').textContent=t; o.querySelector('.start-hint').textContent=h;
}

document.querySelectorAll('.diff-btn').forEach(b=>{
  b.addEventListener('touchstart', (e)=>{
    e.preventDefault(); document.querySelectorAll('.diff-btn').forEach(x=>x.classList.remove('selected'));
    b.classList.add('selected'); selDiff=b.dataset.diff;
  });
});

initMap(); loop();
</script>
</body>
</html>